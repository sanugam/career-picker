<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CareerPicker</title>
  <style>
    :root{
      --bg:#f3f6fb;
      --ink:#0b1220;
      --muted:#5b6475;
      --card:#ffffff;
      --line:#e6ebf3;
      --blue:#003b95; /* booking-ish */
      --blue2:#002a66;
      --accent:#febb02; /* booking-ish yellow */
      --shadow: 0 12px 30px rgba(13, 28, 66, .12);
      --shadow2: 0 8px 20px rgba(13, 28, 66, .10);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:var(--bg);
    }

    /* Topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(243,246,251,.88);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(230,235,243,.7);
    }
    .topbar-inner{
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 800;
      letter-spacing: -.2px;
    }
    .brand-dot{
      width:10px;height:10px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #febb02, #d19b00);
      box-shadow: 0 0 0 4px rgba(254,187,2,.15);
    }
    .top-actions{display:flex;gap:10px;align-items:center}
    .pill{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight: 700;
      color:#1a2440;
      cursor:pointer;
    }
    .pill.primary{
      background: linear-gradient(180deg, #0a3a86, #05306f);
      border-color: rgba(255,255,255,.2);
      color:#fff;
      box-shadow: 0 10px 24px rgba(0,59,149,.22);
    }

    /* Hero */
    .hero{
      background: radial-gradient(1200px 420px at 20% 20%, rgba(254,187,2,.20), transparent 55%),
                  radial-gradient(900px 380px at 70% 30%, rgba(95,163,255,.18), transparent 60%),
                  linear-gradient(180deg, var(--blue), var(--blue2));
      color:#fff;
      padding: 36px 0 26px;
    }
    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding: 0 18px;
    }
    .hero h1{
      margin: 0;
      font-size: 54px;
      line-height: 1.02;
      letter-spacing: -1.2px;
      color: rgba(255,255,255,.95);
    }
    .hero p{
      margin: 12px 0 0;
      font-size: 16px;
      color: rgba(255,255,255,.86);
      max-width: 820px;
    }

    /* Search Bar (booking-like) */
    .searchbar{
      margin-top: 18px;
      background: var(--accent);
      border-radius: 18px;
      padding: 4px;
      box-shadow: 0 14px 34px rgba(0,0,0,.25);
    }
    .searchgrid{
      display:grid;
      grid-template-columns: 2.15fr .75fr 1.25fr .7fr;
      gap:4px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .hero h1{font-size:40px}
      .searchgrid{grid-template-columns: 1fr; }
    }

    .field{
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      min-height: 74px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .field .icon{
      width: 34px; height:34px; border-radius: 10px;
      background: #f4f7ff;
      display:flex;align-items:center;justify-content:center;
      border:1px solid #e7efff;
      color:#1a3b84;
      flex:0 0 auto;
    }
    .field label{
      font-size:12px;
      font-weight:800;
      color:#1b2642;
      display:block;
      margin-bottom: 2px;
    }
    .field small{
      display:block;
      color: var(--muted);
      font-weight:600;
      font-size: 12px;
      margin-top: 2px;
    }
    .field input, .field select, .field button{
      font: inherit;
    }
    .field .stack{width:100%}
    .field input, .field select{
      width:100%;
      border:0;
      outline:0;
      font-weight: 800;
      font-size: 16px;
      color:#0b1220;
      background: transparent;
      padding: 2px 0;
    }

    .cta{
      border-radius: 14px;
      background: #0a3a86;
      color:#fff;
      font-weight: 900;
      border:0;
      cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
    }
    .cta:hover{filter: brightness(1.04)}
    .cta:active{transform: translateY(1px)}
    .cta .btn-inner{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 14px 14px;
      height: 74px;
      font-size: 16px;
    }

    /* Info strip */
    .strip{
      margin-top: 12px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      padding: 10px 12px;
      color: rgba(255,255,255,.86);
      font-weight: 700;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.18);
      font-size: 12px;
      font-weight: 900;
    }

    /* Main */
    .main{
      padding: 22px 0 60px;
    }
    .grid4{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      margin-top: 18px;
    }
    @media (max-width: 980px){ .grid4{grid-template-columns:1fr; } }

    .info-card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px 14px;
      box-shadow: var(--shadow2);
    }
    .info-card h4{margin:0;font-size:15px}
    .info-card p{margin:6px 0 0;color:var(--muted);font-weight:650;font-size:13px;line-height:1.35}

    /* Filters row */
    .filters{
      margin-top: 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      background:#fff;
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 850;
      color:#1a2440;
      cursor:pointer;
      user-select:none;
    }
    .chip.on{
      border-color:#b8ccff;
      background:#eef4ff;
      color:#0a3a86;
    }
    .chip small{
      margin-left:6px;
      font-weight:900;
      color:#6b7390;
    }
    .divider{
      width:1px;height:28px;background:var(--line);
      margin: 0 4px;
    }

    /* Results */
    .section-title{
      margin: 22px 0 10px;
      font-size: 34px;
      letter-spacing: -.8px;
    }
    .section-sub{
      margin: -6px 0 16px;
      color: var(--muted);
      font-weight: 700;
    }

    .cats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-top: 6px;
    }
    @media (max-width: 980px){ .cats{grid-template-columns:1fr;} }

    .cat{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 14px 14px;
      box-shadow: var(--shadow2);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .cat::after{
      content:"";
      position:absolute; inset:-40px -40px auto auto;
      width:140px;height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(254,187,2,.30), transparent 60%);
      transform: rotate(12deg);
    }
    .cat h3{margin:0;font-size:18px}
    .cat p{margin:6px 0 0;color:var(--muted);font-weight:700;font-size:13px;line-height:1.35}
    .cat .row{
      margin-top:10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .mini{
      display:inline-flex;
      gap:8px; align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background:#f6f8ff;
      border:1px solid #e6ebff;
      font-weight:900;
      font-size:12px;
      color:#1a3b84;
    }
    .mini strong{font-size:12px}
    .cat.active{
      outline: 3px solid rgba(254,187,2,.65);
      outline-offset: 2px;
    }

    .cards{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }
    .card{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow2);
      overflow:hidden;
      cursor:pointer;
    }
    .card-top{
      padding: 14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .card h2{
      margin:0;
      font-size: 22px;
      letter-spacing:-.4px;
    }
    .tags{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tag{
      padding: 6px 10px;
      border-radius: 999px;
      background:#f5f7fb;
      border:1px solid #e9eef7;
      font-weight:850;
      color:#33405e;
      font-size: 12px;
    }
    .match{
      font-weight: 950;
      font-size: 20px;
      color:#0a3a86;
      white-space:nowrap;
    }

    .quickfacts{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .qf{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 12px;
      background:#fbfcff;
      border:1px solid #edf2fb;
      font-weight: 900;
      color:#26314f;
      font-size: 12px;
    }
    .qf span{color:#6b7390;font-weight:900}

    .expand{
      display:none;
      padding: 0 16px 16px;
      border-top: 1px solid var(--line);
    }
    .card.open .expand{display:block}
    .cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){ .cols{grid-template-columns:1fr;} }

    .box{
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      background:#fff;
    }
    .box h4{margin:0;font-size:14px}
    .box ul{margin:8px 0 0; padding-left: 18px; color:#2a3554; font-weight: 750; line-height:1.45}
    .box li{margin:6px 0}
    .notes{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .note-badge{
      font-size: 12px;
      font-weight: 950;
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px solid var(--line);
      background:#fff;
      color:#223055;
    }
    .note-badge.rule{border-color:#ffe7a3;background:#fff8dd}
    .note-badge.formal{border-color:#cbe6ff;background:#eef7ff}
    .note-badge.licensed{border-color:#ffd0d0;background:#fff0f0}

    /* Footer controls */
    .bottom-row{
      margin-top: 16px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      color:#1a2440;
    }
    .btn.primary{
      background: linear-gradient(180deg, #0a3a86, #05306f);
      color:#fff;
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 10px 24px rgba(0,59,149,.20);
    }
    .btn:active{transform: translateY(1px)}

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(6, 12, 26, .55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(760px, 100%);
      background:#fff;
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 22px 70px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.15);
    }
    .modal-head{
      background: linear-gradient(180deg, #0a3a86, #05306f);
      color:#fff;
      padding: 16px 18px;
    }
    .modal-head h3{margin:0;font-size:26px;letter-spacing:-.5px}
    .modal-head p{margin:8px 0 0;color:rgba(255,255,255,.86);font-weight:700;line-height:1.35}
    .modal-body{padding: 14px 18px 16px}
    .mode-cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 740px){ .mode-cards{grid-template-columns:1fr;} }

    .mode{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 14px 14px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      background:#fff;
    }
    .mode h4{margin:0;font-size:16px}
    .mode p{margin:6px 0 0;color:var(--muted);font-weight:700;font-size:13px;line-height:1.35}
    .mode.on{
      outline: 3px solid rgba(254,187,2,.65);
      outline-offset: 2px;
    }
    .modal-foot{
      margin-top: 10px;
      color:#6b7390;
      font-weight: 800;
      font-size: 12px;
    }

    /* Profession dropdown */
    .combo{
      position:relative;
    }
    .dropdown{
      position:absolute;
      left:0; right:0;
      top: 72px;
      background:#fff;
      border:1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 18px 50px rgba(0,0,0,.20);
      overflow:hidden;
      z-index: 30;
      display:none;
    }
    .dropdown.show{display:block}
    .dropdown-head{
      padding: 10px 12px;
      background: #f7f9ff;
      border-bottom:1px solid #e9efff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-weight: 950;
      color:#1a2440;
    }
    .dropdown-head span{
      font-size: 12px;
      color:#6b7390;
      font-weight: 900;
    }
    .list{
      max-height: 320px;
      overflow:auto;
    }
    .item{
      padding: 12px 12px;
      border-bottom:1px solid #eef2fb;
      display:flex;
      gap:10px;
      align-items:center;
      cursor:pointer;
    }
    .item:hover{background:#f7faff}
    .item .bubble{
      width:38px;height:38px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:#f2f6ff;border:1px solid #e6eeff;
      color:#1a3b84;
      font-weight: 950;
      flex:0 0 auto;
    }
    .item .meta{min-width:0}
    .item .title{
      font-weight: 950;
      color:#0b1220;
      line-height:1.2;
    }
    .item .sub{
      margin-top: 2px;
      color:#6b7390;
      font-weight: 800;
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 520px;
    }

    /* Toast */
    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background:#0b1220;
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      box-shadow: 0 12px 34px rgba(0,0,0,.30);
      display:none;
      z-index: 80;
    }
    .toast.show{display:block}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="brand-dot"></span>
        <span>CareerPicker</span>
      </div>
      <div class="top-actions">
        <button class="pill" id="aboutBtn">About</button>
        <button class="pill primary" id="saveBtnTop">Save (later)</button>
      </div>
    </div>
  </div>

  <section class="hero">
    <div class="wrap">
      <h1>Find your next career</h1>
      <p>
        Start with your <strong>ATAR/GPA</strong> and get realistic options first. If you already have a job in mind,
        you can also search it from a real list (type to filter, scroll to browse).
      </p>

      <div class="searchbar" aria-label="Career search bar">
        <div class="searchgrid">

          <!-- Profession -->
          <div class="field combo" id="combo">
            <div class="icon" aria-hidden="true">üíº</div>
            <div class="stack">
              <label for="professionInput">Profession (optional)</label>
              <input id="professionInput" placeholder="Start typing‚Ä¶ (must pick from list)" autocomplete="off" />
              <small id="professionHint">Explore mode: leave blank to see options for your score.</small>
            </div>

            <div class="dropdown" id="dropdown" role="listbox" aria-label="Profession list">
              <div class="dropdown-head">
                <div>Professions</div>
                <span>Type to filter ‚Ä¢ Scroll ‚Ä¢ Enter to select</span>
              </div>
              <div class="list" id="dropdownList"></div>
            </div>
          </div>

          <!-- Score -->
          <div class="field">
            <div class="icon" aria-hidden="true">üìÑ</div>
            <div class="stack">
              <label for="scoreInput"><span id="scoreLabel">ATAR</span> (<span id="scoreRangeLabel">0.00‚Äì99.95</span>)</label>
              <input id="scoreInput" type="number" inputmode="decimal" step="0.01" min="0" max="99.95" value="70.00" />
              <small id="modeLine">Mode: <strong id="modeName">ATAR</strong></small>
            </div>
          </div>

          <!-- Salary circumstance -->
          <div class="field">
            <div class="icon" aria-hidden="true">üí∞</div>
            <div class="stack">
              <label for="salarySelect">Salary circumstance (AUD)</label>
              <select id="salarySelect">
                <option value="low">Low ‚Äî self only (‚âà $45k‚Äì$70k)</option>
                <option value="mid" selected>Medium ‚Äî couple / shared costs (‚âà $70k‚Äì$110k)</option>
                <option value="high">High ‚Äî family / mortgage (‚âà $110k‚Äì$170k)</option>
                <option value="growth">High growth ‚Äî aiming top end (‚âà $170k+)</option>
              </select>
              <small>Used to bias results (not a promise).</small>
            </div>
          </div>

          <!-- CTA -->
          <button class="cta" id="searchBtn" type="button" aria-label="Get shortlist">
            <div class="btn-inner">Search</div>
          </button>

        </div>
      </div>

      <div class="strip" id="eligStrip">
        <span class="badge">Real-list matching</span>
        <span class="badge">Explainable output</span>
        <span class="badge">Prototype-safe evidence notes</span>
        <span class="badge" id="eligibleCountBadge">Eligible in list: ‚Äî</span>
      </div>

      <div class="filters" aria-label="Filters">
        <div class="chip on" data-filter="study" data-value="any" id="studyAny">Study: Any</div>
        <div class="chip" data-filter="study" data-value="short">0‚Äì1y</div>
        <div class="chip" data-filter="study" data-value="mid">2‚Äì3y</div>
        <div class="chip" data-filter="study" data-value="long">4y+</div>

        <div class="divider"></div>

        <div class="chip on" data-filter="people" data-value="any">People/Systems: Any</div>
        <div class="chip" data-filter="people" data-value="people">More people</div>
        <div class="chip" data-filter="people" data-value="systems">More systems</div>

        <div class="divider"></div>

        <div class="chip on" data-filter="activity" data-value="any">Desk/Active: Any</div>
        <div class="chip" data-filter="activity" data-value="desk">Desk</div>
        <div class="chip" data-filter="activity" data-value="active">On-feet</div>

        <div class="divider"></div>

        <div class="chip on" data-filter="setting" data-value="any">Indoor/Outdoor: Any</div>
        <div class="chip" data-filter="setting" data-value="indoor">Indoor</div>
        <div class="chip" data-filter="setting" data-value="outdoor">Outdoor</div>
      </div>
    </div>
  </section>

  <main class="main">
    <div class="wrap">

      <div class="grid4">
        <div class="info-card">
          <h4>Fast options</h4>
          <p>Enter your score ‚Üí see realistic paths immediately. No sign-up needed.</p>
        </div>
        <div class="info-card">
          <h4>Explainable matches</h4>
          <p>We show why it fits: score eligibility + work style + salary bias.</p>
        </div>
        <div class="info-card">
          <h4>Designed for students</h4>
          <p>Works for Year 9‚Äì12 planning (AU-first). Add state/uni detail later.</p>
        </div>
        <div class="info-card">
          <h4>Save + share (prototype)</h4>
          <p>Save shortlists locally now. Share via URL parameters.</p>
        </div>
      </div>

      <h2 class="section-title">Your shortlist</h2>
      <div class="section-sub" id="subline">
        Start with score first. (Profession is optional.) Click a card to expand details.
      </div>

      <div class="cats" id="cats"></div>

      <div class="cards" id="results"></div>

      <div class="bottom-row">
        <button class="btn" id="resetBtn">Reset</button>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="shareBtn">Share link</button>
          <button class="btn primary" id="saveBtn">Save shortlist</button>
        </div>
      </div>

      <div style="margin-top:14px; color:#6b7390; font-weight:800; font-size:12px;">
        Evidence notes: some items are <strong>rule-of-thumb</strong> (typical), others are <strong>formal/licensed</strong>.
        This prototype does not guarantee entry; requirements vary by university, state, and year.
        <span id="lastUpdated"></span>
      </div>

    </div>
  </main>

  <!-- Mode modal -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Choose ATAR or GPA">
    <div class="modal">
      <div class="modal-head">
        <h3>Start: Are you using ATAR or GPA?</h3>
        <p>
          We‚Äôll filter professions based on your score. Low scores still have options (traineeships, retail,
          hospitality, trades). Example: ‚ÄúDoctor‚Äù won‚Äôt appear unless your score is high enough.
        </p>
      </div>
      <div class="modal-body">
        <div class="mode-cards">
          <div class="mode" id="modeATAR">
            <h4>ATAR (0.00‚Äì99.95)</h4>
            <p>Australian high school planning. (ATAR does not reach 100.)</p>
          </div>
          <div class="mode" id="modeGPA">
            <h4>GPA (0‚Äì100, prototype scale)</h4>
            <p>If you‚Äôre treating GPA like a 0‚Äì100 score. We‚Äôll apply similar filtering.</p>
          </div>
        </div>
        <div class="modal-foot">
          Note: these cutoffs are simplified and ‚Äúprototype-safe‚Äù ‚Äî not official requirements. We can refine later by state/uni.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

<script>
/* -----------------------------
   Data model (200+ professions)
   ----------------------------- */

const DATA_UPDATED = "Last updated: " + new Date().toISOString().slice(0,10);

function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
function $(id){ return document.getElementById(id); }

const SALARY_BIAS = {
  low:   { targetMin: 45000, targetMax: 70000,  weightHigh: 0.25 },
  mid:   { targetMin: 70000, targetMax: 110000, weightHigh: 0.55 },
  high:  { targetMin: 110000, targetMax: 170000, weightHigh: 0.80 },
  growth:{ targetMin: 170000, targetMax: 260000, weightHigh: 1.00 }
};

const CATEGORY_INFO = {
  "Healthcare": {
    summary: "Patient care, allied health, hospitals, community services.",
    icon: "ü©∫"
  },
  "Tech & Data": {
    summary: "Software, cybersecurity, data, cloud, product building.",
    icon: "üíª"
  },
  "Trades & Construction": {
    summary: "Hands-on building, electrical, plumbing, construction, maintenance.",
    icon: "üõ†Ô∏è"
  },
  "Business & Finance": {
    summary: "Accounting, banking, analysis, operations, management.",
    icon: "üìà"
  },
  "Law & Government": {
    summary: "Law, policy, policing, public service, compliance.",
    icon: "‚öñÔ∏è"
  },
  "Creative & Media": {
    summary: "Design, content, film, marketing, creative production.",
    icon: "üé®"
  },
  "Education & Social": {
    summary: "Teaching, youth work, community support, mentoring.",
    icon: "üìö"
  },
  "Engineering": {
    summary: "Civil, mechanical, electrical, systems, infrastructure.",
    icon: "üß†"
  },
  "Hospitality & Retail": {
    summary: "Customer service, events, food, retail operations, tourism.",
    icon: "üçΩÔ∏è"
  },
  "Logistics & Services": {
    summary: "Transport, supply chain, admin, customer operations.",
    icon: "üöö"
  }
};

// Base roles: each item is ‚Äúreal-ish‚Äù and we expand variants to reach 200+.
const BASE = [
  // Healthcare
  mk("Doctor", "Healthcare", 98.00, "long", "people", "active", "indoor", ["Medicine","Hospitals"], {licensed:true}, [120000, 280000], "Diagnose and treat patients."),
  mk("Nurse", "Healthcare", 70.00, "long", "people", "active", "indoor", ["Nursing","Patient care"], {licensed:true}, [70000, 120000], "Clinical care, wards, triage."),
  mk("Paramedic", "Healthcare", 78.00, "long", "people", "active", "outdoor", ["Emergency","Ambulance"], {licensed:true}, [80000, 130000], "Emergency response and transport."),
  mk("Physiotherapist", "Healthcare", 85.00, "long", "people", "active", "indoor", ["Rehab","Sports"], {licensed:true}, [75000, 130000], "Movement and rehab therapy."),
  mk("Psychologist", "Healthcare", 90.00, "long", "people", "desk", "indoor", ["Mental health","Therapy"], {licensed:true}, [80000, 170000], "Assessment and therapy."),
  mk("Pharmacist", "Healthcare", 87.00, "long", "people", "active", "indoor", ["Medicines","Community"], {licensed:true}, [70000, 130000], "Dispense and counsel medications."),
  mk("Dental Practitioner", "Healthcare", 95.00, "long", "people", "active", "indoor", ["Dentistry","Clinics"], {licensed:true}, [110000, 260000], "Oral health diagnosis/treatment."),
  mk("Radiographer", "Healthcare", 80.00, "long", "people", "active", "indoor", ["Imaging","Hospitals"], {licensed:true}, [75000, 130000], "Medical imaging and scans."),
  mk("Occupational Therapist", "Healthcare", 82.00, "long", "people", "active", "indoor", ["Rehab","Support"], {licensed:true}, [70000, 120000], "Daily living support plans."),

  // Tech & Data
  mk("Software Developer", "Tech & Data", 70.00, "mid", "systems", "desk", "indoor", ["Coding","Apps"], {rule:true}, [80000, 180000], "Build software products."),
  mk("Cybersecurity Analyst", "Tech & Data", 78.00, "mid", "systems", "desk", "indoor", ["Security","Defence"], {rule:true}, [90000, 190000], "Protect systems from threats."),
  mk("Data Analyst", "Tech & Data", 68.00, "mid", "systems", "desk", "indoor", ["Data","Insights"], {rule:true}, [75000, 140000], "Turn data into decisions."),
  mk("Data Scientist", "Tech & Data", 85.00, "long", "systems", "desk", "indoor", ["ML","Stats"], {rule:true}, [100000, 220000], "Advanced modelling and prediction."),
  mk("Cloud Engineer", "Tech & Data", 80.00, "mid", "systems", "desk", "indoor", ["AWS","Infra"], {rule:true}, [110000, 220000], "Deploy and run cloud systems."),
  mk("Product Manager", "Tech & Data", 75.00, "mid", "people", "desk", "indoor", ["Product","Planning"], {rule:true}, [120000, 230000], "Define what to build and why."),
  mk("UI/UX Designer", "Creative & Media", 60.00, "mid", "people", "desk", "indoor", ["Design","UX"], {rule:true}, [70000, 160000], "Design user experiences."),

  // Trades & Construction
  mk("Electrician", "Trades & Construction", 50.00, "mid", "systems", "active", "indoor", ["Electrical","Trade"], {licensed:true}, [75000, 140000], "Install and repair electrical systems."),
  mk("Plumber", "Trades & Construction", 45.00, "mid", "systems", "active", "indoor", ["Plumbing","Trade"], {licensed:true}, [75000, 140000], "Install and maintain plumbing."),
  mk("Carpenter", "Trades & Construction", 40.00, "mid", "systems", "active", "outdoor", ["Building","Trade"], {rule:true}, [65000, 120000], "Build structures and frames."),
  mk("Civil Construction Worker", "Trades & Construction", 25.00, "short", "systems", "active", "outdoor", ["Roads","Sites"], {rule:true}, [55000, 95000], "Site work and construction tasks."),
  mk("Surveyor", "Engineering", 70.00, "mid", "systems", "active", "outdoor", ["Land","Measurement"], {rule:true}, [80000, 150000], "Measure and map land."),

  // Business & Finance
  mk("Accountant", "Business & Finance", 65.00, "mid", "systems", "desk", "indoor", ["Accounting","Tax"], {rule:true}, [70000, 160000], "Financial reporting and analysis."),
  mk("Business Analyst", "Business & Finance", 60.00, "mid", "people", "desk", "indoor", ["Process","Requirements"], {rule:true}, [80000, 170000], "Improve systems and processes."),
  mk("Financial Analyst", "Business & Finance", 75.00, "mid", "systems", "desk", "indoor", ["Finance","Markets"], {rule:true}, [85000, 190000], "Forecasting and valuation."),
  mk("Operations Manager", "Business & Finance", 55.00, "mid", "people", "active", "indoor", ["Ops","Management"], {rule:true}, [80000, 170000], "Run day-to-day operations."),

  // Law & Government
  mk("Lawyer", "Law & Government", 85.00, "long", "people", "desk", "indoor", ["Law","Advice"], {formal:true}, [80000, 200000], "Advise and represent clients."),
  mk("Paralegal", "Law & Government", 60.00, "mid", "systems", "desk", "indoor", ["Law","Support"], {rule:true}, [55000, 90000], "Legal support and documentation."),
  mk("Police Officer", "Law & Government", 55.00, "mid", "people", "active", "outdoor", ["Policing","Service"], {formal:true}, [70000, 120000], "Community safety and response."),
  mk("Policy Officer", "Law & Government", 70.00, "mid", "systems", "desk", "indoor", ["Policy","Public service"], {rule:true}, [75000, 140000], "Design and evaluate policy."),
  mk("Compliance Officer", "Law & Government", 65.00, "mid", "systems", "desk", "indoor", ["Compliance","Risk"], {rule:true}, [80000, 160000], "Regulation and risk controls."),

  // Creative & Media
  mk("Graphic Designer", "Creative & Media", 45.00, "short", "people", "desk", "indoor", ["Design","Brand"], {rule:true}, [55000, 110000], "Visual design and branding."),
  mk("Video Editor", "Creative & Media", 45.00, "short", "systems", "desk", "indoor", ["Editing","Media"], {rule:true}, [55000, 120000], "Edit and produce video."),
  mk("Digital Marketer", "Creative & Media", 50.00, "short", "people", "desk", "indoor", ["Marketing","Ads"], {rule:true}, [60000, 140000], "Run growth and marketing campaigns."),
  mk("Journalist", "Creative & Media", 60.00, "mid", "people", "active", "indoor", ["Writing","News"], {rule:true}, [60000, 120000], "Investigate and report stories."),

  // Education & Social
  mk("Teacher", "Education & Social", 65.00, "long", "people", "active", "indoor", ["Education","School"], {formal:true}, [70000, 125000], "Teach and support students."),
  mk("Social Worker", "Education & Social", 70.00, "long", "people", "active", "indoor", ["Support","Community"], {formal:true}, [75000, 120000], "Support vulnerable people."),
  mk("Youth Worker", "Education & Social", 45.00, "mid", "people", "active", "indoor", ["Youth","Support"], {rule:true}, [55000, 90000], "Support young people."),

  // Hospitality & Retail (low score-friendly)
  mk("Chef", "Hospitality & Retail", 30.00, "mid", "people", "active", "indoor", ["Food","Kitchen"], {rule:true}, [55000, 100000], "Cook and manage kitchen ops."),
  mk("Barista", "Hospitality & Retail", 10.00, "short", "people", "active", "indoor", ["Coffee","Service"], {rule:true}, [45000, 65000], "Customer service and coffee."),
  mk("Retail Manager", "Hospitality & Retail", 25.00, "mid", "people", "active", "indoor", ["Retail","Ops"], {rule:true}, [60000, 110000], "Manage retail store operations."),
  mk("Event Coordinator", "Hospitality & Retail", 45.00, "short", "people", "active", "indoor", ["Events","Planning"], {rule:true}, [60000, 120000], "Plan and run events."),

  // Logistics & Services
  mk("Customer Service Rep", "Logistics & Services", 10.00, "short", "people", "desk", "indoor", ["Support","Calls"], {rule:true}, [45000, 70000], "Help customers solve issues."),
  mk("Administration Officer", "Logistics & Services", 15.00, "short", "systems", "desk", "indoor", ["Admin","Office"], {rule:true}, [48000, 80000], "Office and admin operations."),
  mk("Supply Chain Coordinator", "Logistics & Services", 45.00, "mid", "systems", "desk", "indoor", ["Logistics","Planning"], {rule:true}, [65000, 120000], "Plan inventory and logistics."),
  mk("Truck Driver", "Logistics & Services", 15.00, "short", "systems", "active", "outdoor", ["Transport","Routes"], {formal:true}, [60000, 110000], "Deliver goods and manage routes.")
];

// Helper to create a profession object
function mk(name, category, cutoff, studyLen, people, activity, setting, tags, evidenceFlags, salaryRange, oneLine){
  return {
    name,
    category,
    cutoff: +cutoff,
    studyLen,        // short | mid | long
    people,          // people | systems
    activity,        // desk | active
    setting,         // indoor | outdoor
    tags,
    evidence: evidenceFlags,  // {rule:true} {formal:true} {licensed:true}
    salaryRange,     // [min,max]
    oneLine
  };
}

// Expand to 200+ by generating realistic variants (specialisations) per base profession/category.
function generateVariants(baseList){
  const variants = [];
  const specMap = {
    "Doctor": ["GP", "Emergency Doctor", "Paediatric Doctor", "Anaesthetist (path)", "Surgical Doctor (path)"],
    "Nurse": ["Registered Nurse", "ICU Nurse", "Theatre Nurse", "Mental Health Nurse", "Aged Care Nurse"],
    "Software Developer": ["Frontend Developer", "Backend Developer", "Mobile App Developer", "Game Developer", "QA Engineer"],
    "Cybersecurity Analyst": ["Security Engineer", "SOC Analyst", "GRC Analyst", "Penetration Tester (path)", "Incident Responder"],
    "Electrician": ["Residential Electrician", "Commercial Electrician", "Solar Electrician", "Industrial Electrician", "Electrical Apprentice"],
    "Plumber": ["Gas Fitter", "Drainage Plumber", "Roof Plumber", "Maintenance Plumber", "Plumbing Apprentice"],
    "Accountant": ["Tax Accountant", "Management Accountant", "Audit Associate", "Bookkeeper", "Payroll Officer"],
    "Lawyer": ["Family Lawyer", "Criminal Lawyer", "Corporate Lawyer", "Property Lawyer", "Legal Graduate (path)"],
    "Teacher": ["Primary Teacher", "Secondary Teacher", "Maths Teacher", "Science Teacher", "Education Support Officer"],
    "Chef": ["Sous Chef", "Pastry Chef", "Cook", "Kitchen Hand", "Catering Assistant"],
    "Truck Driver": ["Delivery Driver", "Forklift Operator", "Warehouse Picker", "Dispatch Coordinator", "Logistics Assistant"]
  };

  const genericByCategory = {
    "Healthcare": ["Clinic Assistant", "Allied Health Assistant", "Support Worker", "Medical Receptionist", "Aged Care Worker"],
    "Tech & Data": ["IT Support", "Systems Administrator", "DevOps Engineer", "Technical Writer", "Business Intelligence Analyst"],
    "Trades & Construction": ["Painter", "Tiler", "Welder", "Landscaper", "Construction Supervisor"],
    "Business & Finance": ["HR Coordinator", "Recruiter", "Procurement Officer", "Project Coordinator", "Sales Associate"],
    "Law & Government": ["Court Officer", "Regulatory Analyst", "Government Graduate", "Policy Assistant", "Records Officer"],
    "Creative & Media": ["Content Creator", "Copywriter", "Social Media Manager", "Photographer", "Motion Designer"],
    "Education & Social": ["Teacher Aide", "Tutor", "Disability Support Worker", "Community Worker", "Counsellor (path)"],
    "Engineering": ["Mechanical Engineer", "Electrical Engineer", "Civil Engineer", "Environmental Engineer", "Engineering Technician"],
    "Hospitality & Retail": ["Waiter", "Bartender", "Hotel Receptionist", "Store Team Member", "Shift Supervisor"],
    "Logistics & Services": ["Call Center Agent", "Office Coordinator", "Field Technician", "Courier", "Service Desk Analyst"]
  };

  // Make variants: for each base role, add some specialization roles with slightly adjusted cutoffs.
  for (const p of baseList){
    const specials = specMap[p.name] || [];
    for (let i=0;i<specials.length;i++){
      const nm = specials[i];
      let c = p.cutoff;
      // Some paths are easier/harder
      if (nm.includes("Apprentice") || nm.includes("Assistant") || nm.includes("Hand")) c = Math.max(0, c - 20);
      if (nm.includes("ICU") || nm.includes("Anaesthetist") || nm.includes("Surgical")) c = Math.min(99.95, c + 6);
      if (nm.includes("Penetration Tester")) c = Math.min(99.95, c + 4);
      if (nm.includes("Graduate") || nm.includes("(path)")) c = Math.max(0, c - 5);

      variants.push({
        ...p,
        name: nm,
        cutoff: +c.toFixed(2),
        oneLine: p.oneLine
      });
    }
  }

  // Add generic roles per category to ensure lots of low-score options exist.
  for (const [cat, names] of Object.entries(genericByCategory)){
    for (const nm of names){
      // heuristic cutoffs by category: keep plenty accessible at low scores
      let cutoff = 20;
      let studyLen = "short";
      let people = "people";
      let activity = "desk";
      let setting = "indoor";
      let salaryRange = [48000, 90000];
      let evidence = {rule:true};

      if (cat === "Healthcare"){ cutoff = 25; activity="active"; salaryRange=[50000, 95000]; }
      if (cat === "Tech & Data"){ cutoff = 45; people="systems"; salaryRange=[65000, 140000]; }
      if (cat === "Trades & Construction"){ cutoff = 20; activity="active"; setting="outdoor"; salaryRange=[55000, 120000]; }
      if (cat === "Business & Finance"){ cutoff = 40; people="people"; salaryRange=[60000, 130000]; }
      if (cat === "Law & Government"){ cutoff = 45; people="systems"; salaryRange=[65000, 140000]; }
      if (cat === "Creative & Media"){ cutoff = 30; salaryRange=[52000, 120000]; }
      if (cat === "Education & Social"){ cutoff = 35; activity="active"; salaryRange=[55000, 110000]; }
      if (cat === "Engineering"){ cutoff = 70; people="systems"; studyLen="long"; salaryRange=[90000, 200000]; }
      if (cat === "Hospitality & Retail"){ cutoff = 10; activity="active"; salaryRange=[45000, 90000]; }
      if (cat === "Logistics & Services"){ cutoff = 15; salaryRange=[48000, 110000]; if (nm.includes("Field") || nm.includes("Courier")) {activity="active"; setting="outdoor";} }

      variants.push(mk(nm, cat, cutoff, studyLen, people, activity, setting, [cat.split(" ")[0]], evidence, salaryRange, `A common role in ${cat.toLowerCase()}.`));
    }
  }

  // Combine and de-duplicate by name.
  const map = new Map();
  for (const p of [...baseList, ...variants]){
    const key = p.name.toLowerCase();
    if (!map.has(key)) map.set(key, p);
  }
  return Array.from(map.values());
}

const PROFESSIONS = generateVariants(BASE);
// Ensure we have 200+ (usually ~220+)
const TOTAL = PROFESSIONS.length;

/* -----------------------------
   State + UI state
   ----------------------------- */

const state = {
  mode: null, // "ATAR" | "GPA"
  filters: {
    study:"any",
    people:"any",
    activity:"any",
    setting:"any"
  },
  selectedCategory: null,
  selectedProfession: null, // object
};

function defaultMode(){
  return localStorage.getItem("cp_mode") || null;
}

/* -----------------------------
   Mode modal
   ----------------------------- */

function showModeModal(){
  $("overlay").classList.add("show");
  // highlight stored mode if exists
  const m = defaultMode();
  if (m === "ATAR") $("modeATAR").classList.add("on");
  if (m === "GPA") $("modeGPA").classList.add("on");
}
function hideModeModal(){
  $("overlay").classList.remove("show");
}

function setMode(mode){
  state.mode = mode;
  localStorage.setItem("cp_mode", mode);

  if (mode === "ATAR"){
    $("modeATAR").classList.add("on");
    $("modeGPA").classList.remove("on");
    $("modeName").textContent = "ATAR";
    $("scoreLabel").textContent = "ATAR";
    $("scoreRangeLabel").textContent = "0.00‚Äì99.95";
    $("scoreInput").max = "99.95";
    if (+$("scoreInput").value > 99.95) $("scoreInput").value = "99.95";
  } else {
    $("modeGPA").classList.add("on");
    $("modeATAR").classList.remove("on");
    $("modeName").textContent = "GPA";
    $("scoreLabel").textContent = "GPA";
    $("scoreRangeLabel").textContent = "0‚Äì100";
    $("scoreInput").max = "100";
  }

  hideModeModal();
  renderEligibleCount();
}

$("modeATAR").addEventListener("click", ()=> setMode("ATAR"));
$("modeGPA").addEventListener("click", ()=> setMode("GPA"));

/* -----------------------------
   Profession combo dropdown
   ----------------------------- */

const combo = $("combo");
const input = $("professionInput");
const dropdown = $("dropdown");
const list = $("dropdownList");

function iconLetter(name){
  // quick bubble: first letter
  const ch = (name.trim()[0] || "?").toUpperCase();
  return ch;
}

function summarize(p){
  // small subline: category + tags
  const t = (p.tags || []).slice(0,3).join(" ‚Ä¢ ");
  return `${p.category} ‚Ä¢ ${t || "paths"}`.trim();
}

function openDropdown(){
  dropdown.classList.add("show");
}
function closeDropdown(){
  dropdown.classList.remove("show");
}

function setSelectedProfession(p){
  state.selectedProfession = p;
  input.value = p ? p.name : "";
  closeDropdown();
  // selecting a profession makes category selection reset so it can find similar paths
  state.selectedCategory = null;
  renderEligibleCount();
}

function filterProfessionsForDropdown(query, eligibleOnly){
  const q = (query||"").trim().toLowerCase();
  const score = getScore();
  const eligible = eligibleOnly ? getEligibleList(score) : PROFESSIONS;

  let arr = eligible;
  if (q){
    arr = eligible.filter(p => p.name.toLowerCase().includes(q) || (p.category||"").toLowerCase().includes(q));
  }
  // Keep list reasonably sized
  arr = arr.sort((a,b)=> a.name.localeCompare(b.name)).slice(0, 240);
  return arr;
}

function renderDropdown(){
  const eligibleOnly = true;
  const q = input.value;
  const rows = filterProfessionsForDropdown(q, eligibleOnly);

  list.innerHTML = rows.map(p => `
    <div class="item" role="option" data-name="${escapeHtml(p.name)}">
      <div class="bubble">${escapeHtml(iconLetter(p.name))}</div>
      <div class="meta">
        <div class="title">${escapeHtml(p.name)}</div>
        <div class="sub">${escapeHtml(summarize(p))}</div>
      </div>
    </div>
  `).join("");

  // click handlers
  Array.from(list.querySelectorAll(".item")).forEach(el=>{
    el.addEventListener("click", ()=>{
      const name = el.getAttribute("data-name");
      const p = PROFESSIONS.find(x => x.name === name);
      if (p) setSelectedProfession(p);
    });
  });
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

input.addEventListener("focus", ()=>{
  openDropdown();
  renderDropdown();
});
input.addEventListener("input", ()=>{
  openDropdown();
  renderDropdown();
});
input.addEventListener("keydown", (e)=>{
  if (e.key === "Escape"){
    closeDropdown();
    input.blur();
  }
  if (e.key === "Enter"){
    const q = input.value.trim().toLowerCase();
    const score = getScore();
    const eligible = getEligibleList(score);

    // exact match required (forced list)
    const exact = eligible.find(p => p.name.toLowerCase() === q);
    if (exact){
      setSelectedProfession(exact);
      e.preventDefault();
      return;
    }

    // If user typed something not in list, don't accept it.
    // Keep dropdown open and show hint by re-rendering.
    openDropdown();
    renderDropdown();
    e.preventDefault();
  }
});

document.addEventListener("click", (e)=>{
  if (!combo.contains(e.target)){
    closeDropdown();
  }
});

/* -----------------------------
   Filters (chips)
   ----------------------------- */

Array.from(document.querySelectorAll(".chip")).forEach(ch=>{
  ch.addEventListener("click", ()=>{
    const group = ch.getAttribute("data-filter");
    const val = ch.getAttribute("data-value");
    if (!group) return;

    // turn off all in group, turn on selected
    Array.from(document.querySelectorAll(`.chip[data-filter="${group}"]`)).forEach(x=>x.classList.remove("on"));
    ch.classList.add("on");
    state.filters[group] = val;

    // rerun results if already showing
    runSearch(false);
  });
});

/* -----------------------------
   Scoring + eligibility
   ----------------------------- */

function getScore(){
  const raw = parseFloat($("scoreInput").value);
  const max = (state.mode === "ATAR") ? 99.95 : 100;
  const v = clamp(isNaN(raw) ? 0 : raw, 0, max);
  return +v.toFixed(2);
}

function getEligibleList(score){
  // Mode logic: same for now (prototype). Later can map GPA to ATAR distribution.
  // Important: always have low-score options.
  return PROFESSIONS.filter(p => score >= p.cutoff);
}

function renderEligibleCount(){
  const score = getScore();
  const eligible = getEligibleList(score);
  $("eligibleCountBadge").textContent = `Eligible in list: ${eligible.length} / ${TOTAL}`;
}

/* -----------------------------
   Ranking logic (interpreting your ‚Äúreal behaviors‚Äù)
   - If no profession selected: explore ‚Üí show best categories + careers
   - If profession selected: show related careers (same category + similar attributes)
   - Always explain why
   ----------------------------- */

function dist(a, b){
  let d = 0;
  if (a.category !== b.category) d += 2;
  if (a.studyLen !== b.studyLen) d += 1;
  if (a.people !== b.people) d += 1;
  if (a.activity !== b.activity) d += 1;
  if (a.setting !== b.setting) d += 1;
  return d;
}

function salaryFitScore(p, biasKey){
  const bias = SALARY_BIAS[biasKey] || SALARY_BIAS.mid;
  const [minS, maxS] = p.salaryRange;
  // reward overlap with target range
  const overlap = Math.max(0, Math.min(maxS, bias.targetMax) - Math.max(minS, bias.targetMin));
  const span = (bias.targetMax - bias.targetMin) || 1;
  const overlapRatio = overlap / span;

  // also slightly reward higher ceiling for growth
  const ceilingBoost = (maxS / 260000);
  const w = bias.weightHigh;

  return (overlapRatio * (0.7 + 0.3*w)) + (ceilingBoost * (0.15*w));
}

function applyFilters(list){
  const f = state.filters;
  return list.filter(p=>{
    if (f.study !== "any" && p.studyLen !== f.study) return false;
    if (f.people !== "any" && p.people !== f.people) return false;
    if (f.activity !== "any" && p.activity !== f.activity) return false;
    if (f.setting !== "any" && p.setting !== f.setting) return false;
    if (state.selectedCategory && p.category !== state.selectedCategory) return false;
    return true;
  });
}

function computeCategoryScores(list, salaryKey){
  const byCat = new Map();
  for (const p of list){
    const s = salaryFitScore(p, salaryKey);
    if (!byCat.has(p.category)) byCat.set(p.category, {count:0, score:0});
    const o = byCat.get(p.category);
    o.count += 1;
    o.score += s;
  }
  const arr = Array.from(byCat.entries()).map(([cat, o])=>{
    const avg = o.score / Math.max(1,o.count);
    return {cat, count:o.count, avg};
  });
  arr.sort((a,b)=> b.avg - a.avg || b.count - a.count);
  return arr;
}

function pickShortlist(eligible, salaryKey){
  const base = applyFilters(eligible);

  // If profession selected: prioritize ‚Äúrelated paths‚Äù
  if (state.selectedProfession){
    const target = state.selectedProfession;

    // Always include the target profession first (if eligible)
    const related = base
      .filter(p => p.name !== target.name)
      .map(p => {
        const similarity = 1 / (1 + dist(target,p));
        const sal = salaryFitScore(p, salaryKey);
        // same category gets bonus
        const sameCat = (p.category === target.category) ? 0.35 : 0.0;
        return {p, score: (similarity*0.65 + sal*0.35 + sameCat)};
      })
      .sort((a,b)=> b.score - a.score)
      .slice(0, 8)
      .map(x=>x.p);

    const all = [target, ...related].slice(0, 8);
    return all;
  }

  // Explore mode: pick top careers overall (mix across categories)
  const scored = base.map(p=>{
    const sal = salaryFitScore(p, salaryKey);
    // Heuristic: higher salary fit + slightly prefer mid/long pathways for higher scores
    const score = sal + (p.cutoff/100)*0.12;
    return {p, score};
  }).sort((a,b)=> b.score - a.score);

  // Ensure diversity across categories
  const chosen = [];
  const seenCat = new Map();
  for (const x of scored){
    const catCount = seenCat.get(x.p.category) || 0;
    if (catCount >= 2) continue;
    chosen.push(x.p);
    seenCat.set(x.p.category, catCount + 1);
    if (chosen.length >= 8) break;
  }

  // If filters are too strict and nothing found, relax category filter first.
  if (chosen.length === 0 && state.selectedCategory){
    state.selectedCategory = null;
    return pickShortlist(eligible, salaryKey);
  }

  // Still nothing? return some low-cutoff careers unfiltered
  if (chosen.length === 0){
    const fallback = eligible
      .sort((a,b)=> a.cutoff - b.cutoff)
      .slice(0, 8);
    return fallback;
  }

  return chosen;
}

/* -----------------------------
   Card content generator (3 layers)
   ----------------------------- */

function formatMoney(n){
  const k = Math.round(n/1000);
  return `$${k}k`;
}
function studyLabel(s){
  if (s==="short") return "0‚Äì1y";
  if (s==="mid") return "2‚Äì3y";
  return "4y+";
}
function workLabel(p){
  const parts = [];
  parts.push(p.people === "people" ? "People" : "Systems");
  parts.push(p.activity === "desk" ? "Desk" : "On-feet");
  parts.push(p.setting === "indoor" ? "Indoor" : "Outdoor");
  return parts.join(" ‚Ä¢ ");
}

function evidenceBadges(p){
  const arr = [];
  if (p.evidence?.licensed) arr.push({cls:"licensed", txt:"Licensed / regulated"});
  if (p.evidence?.formal) arr.push({cls:"formal", txt:"Formal requirement"});
  if (p.evidence?.rule) arr.push({cls:"rule", txt:"Rule-of-thumb"});
  if (arr.length===0) arr.push({cls:"rule", txt:"Rule-of-thumb"});
  return arr;
}

function whyBullets(p, score, salaryKey){
  const lines = [];
  lines.push(`Eligible in this list because score ‚â• cutoff (${score.toFixed(2)} ‚â• ${p.cutoff.toFixed(2)}).`);

  if (state.selectedProfession){
    const t = state.selectedProfession;
    const sameCat = (p.category === t.category);
    if (p.name === t.name){
      lines.push(`This is the profession you selected (used as a reference point).`);
    } else if (sameCat){
      lines.push(`Related path: same category as your selection (${t.category}).`);
    } else {
      lines.push(`Alternate path: different category, but similar work style signals.`);
    }
  } else {
    lines.push(`Shown because it fits your filters and salary circumstance bias.`);
  }

  const sfit = salaryFitScore(p, salaryKey);
  if (sfit > 0.55) lines.push(`Salary fit looks strong for your chosen circumstance.`);
  else lines.push(`Salary fit is moderate ‚Äî consider tradeoffs vs lifestyle / training.`);

  lines.push(`Work style: ${workLabel(p)}.`);
  return lines;
}

function startSteps(p){
  // Simple templates that vary by category so cards aren‚Äôt all the same.
  const c = p.category;
  if (c === "Healthcare") return [
    "Check required subjects (often biology/chem) and pathway options.",
    "Plan training (uni + placements). Consider allied-health alternatives.",
    "Build experience: volunteering, first aid, shadowing where possible."
  ];
  if (c === "Tech & Data") return [
    "Start a small portfolio (1‚Äì3 projects) and learn fundamentals.",
    "Consider uni/TAFE/bootcamp/self-taught routes; pick one and commit.",
    "Get experience: internships, GitHub projects, hackathons, freelancing."
  ];
  if (c === "Trades & Construction") return [
    "Explore apprenticeship/TAFE entry points and required tickets/licences.",
    "Get site exposure: work experience, pre-apprenticeship, helper roles.",
    "Build practical skills + safety habits (tools, PPE, basic certs)."
  ];
  if (c === "Business & Finance") return [
    "Build core skills: spreadsheets, communication, basic accounting/finance.",
    "Choose a pathway: uni degree or entry roles + upskilling.",
    "Get experience: part-time admin, internships, school enterprise programs."
  ];
  if (c === "Law & Government") return [
    "Confirm if it‚Äôs licensed/formal and what the entry path is.",
    "Build evidence: debating/writing, volunteering, structured study plan.",
    "Look for junior roles (assistant, admin) to learn the system early."
  ];
  if (c === "Creative & Media") return [
    "Create a portfolio (5‚Äì10 pieces). Real work beats certificates.",
    "Pick a niche (design, video, copy, social) and go deep.",
    "Get feedback and publish: socials, Behance, small clients, school projects."
  ];
  if (c === "Education & Social") return [
    "Try it first: tutoring, coaching, mentoring, volunteering.",
    "Check formal requirements (teaching registration / degrees).",
    "Build skills: communication, patience, structured planning."
  ];
  if (c === "Engineering") return [
    "Check subject prerequisites (often maths/physics).",
    "Choose a branch (civil/mech/elec/software) and plan the pathway.",
    "Build proof: competitions, projects, internships, cad/programming."
  ];
  if (c === "Hospitality & Retail") return [
    "Start with entry roles; learn speed, service, teamwork.",
    "Level up with short courses (food safety, RSA) or supervisor training.",
    "Move into management or specialise (events, venues, operations)."
  ];
  // Logistics & Services
  return [
    "Start with entry roles and learn systems and customer operations.",
    "Upskill with short certs (Excel, tickets, service training).",
    "Move into specialist roles (planning, coordination, team lead)."
  ];
}

function sourcesStub(p){
  // Prototype-safe: we avoid pretending we have official sources here.
  // You can later attach real links per profession/state.
  const c = p.category;
  const out = [];
  out.push("Prototype note: requirements vary by state/university and year.");
  if (p.evidence?.licensed) out.push("Licensed/regulated roles often require registration with a professional body.");
  if (c === "Healthcare") out.push("Typical sources to add later: university course pages + AHPRA/registration bodies.");
  if (c === "Law & Government") out.push("Typical sources to add later: state government recruitment + university law pages.");
  if (c === "Trades & Construction") out.push("Typical sources to add later: apprenticeship networks + state training authorities.");
  if (c === "Tech & Data") out.push("Typical sources to add later: role descriptions + industry certifications.");
  return out;
}

/* -----------------------------
   Render categories + results
   ----------------------------- */

function renderCategories(eligible, salaryKey){
  const cats = $("cats");
  const filtered = applyFilters(eligible); // includes selectedCategory if set
  // but category cards should represent the overall eligible+filters excluding selectedCategory
  const tempSel = state.selectedCategory;
  state.selectedCategory = null;
  const filteredNoCat = applyFilters(eligible);
  state.selectedCategory = tempSel;

  const scores = computeCategoryScores(filteredNoCat, salaryKey).slice(0,3);

  cats.innerHTML = scores.map((c, idx)=>{
    const info = CATEGORY_INFO[c.cat] || {summary:"", icon:"‚ú®"};
    const active = (state.selectedCategory === c.cat) ? "active" : "";
    return `
      <div class="cat ${active}" data-cat="${escapeHtml(c.cat)}">
        <h3>${escapeHtml(info.icon)} ${escapeHtml(c.cat)}</h3>
        <p>${escapeHtml(info.summary)} </p>
        <div class="row">
          <div class="mini"><strong>${c.count}</strong> options</div>
          <div class="mini">Tap to filter</div>
        </div>
      </div>
    `;
  }).join("");

  Array.from(cats.querySelectorAll(".cat")).forEach(el=>{
    el.addEventListener("click", ()=>{
      const cat = el.getAttribute("data-cat");
      if (state.selectedCategory === cat) state.selectedCategory = null;
      else state.selectedCategory = cat;
      runSearch(false);
    });
  });
}

function renderResults(shortlist, eligible, score, salaryKey){
  const results = $("results");
  const titleLine = state.selectedProfession
    ? `Showing related paths to: <strong>${escapeHtml(state.selectedProfession.name)}</strong>`
    : `Explore mode: showing options for your score + filters`;

  $("subline").innerHTML = `${titleLine}. Click a card to expand details.`;

  if (!shortlist || shortlist.length === 0){
    results.innerHTML = `
      <div class="info-card">
        <h4>No matches found</h4>
        <p>Try relaxing filters or clearing the profession/category selection.</p>
      </div>
    `;
    return;
  }

  results.innerHTML = shortlist.map((p, idx)=>{
    const matchPct = calcMatchPercent(p, shortlist[0], score, salaryKey);
    const [smin, smax] = p.salaryRange;
    const ev = evidenceBadges(p);
    const why = whyBullets(p, score, salaryKey);
    const steps = startSteps(p);
    const src = sourcesStub(p);

    return `
      <div class="card" data-name="${escapeHtml(p.name)}">
        <div class="card-top">
          <div style="min-width:0">
            <h2>${escapeHtml((idx+1) + ". " + p.name)}</h2>
            <div class="tags">
              <span class="tag">${escapeHtml(p.category)}</span>
              <span class="tag">${escapeHtml(workLabel(p))}</span>
              <span class="tag">Study: ${escapeHtml(studyLabel(p.studyLen))}</span>
            </div>

            <div class="quickfacts">
              <div class="qf"><span>Salary</span> ${escapeHtml(formatMoney(smin))}‚Äì${escapeHtml(formatMoney(smax))}</div>
              <div class="qf"><span>Cutoff</span> ${escapeHtml(p.cutoff.toFixed(2))}</div>
              <div class="qf"><span>Evidence</span> ${escapeHtml(ev[0].txt)}</div>
            </div>
          </div>
          <div class="match">${matchPct}% match</div>
        </div>

        <div class="expand">
          <div class="cols">
            <div class="box">
              <h4>Why it fits</h4>
              <ul>
                ${why.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
              </ul>
            </div>

            <div class="box">
              <h4>How to start (first steps)</h4>
              <ul>
                ${steps.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
              </ul>
            </div>
          </div>

          <div class="box" style="margin-top:14px;">
            <h4>Day-to-day (quick picture)</h4>
            <ul>
              <li>${escapeHtml(p.oneLine || "A common path with clear entry steps.")}</li>
              <li>${escapeHtml(p.category)} environments often reward consistency and skills growth over time.</li>
              <li>Choose a pathway you can actually sustain week-to-week.</li>
            </ul>
          </div>

          <div class="notes">
            ${ev.map(b=>`<span class="note-badge ${b.cls}">${escapeHtml(b.txt)}</span>`).join("")}
            <span class="note-badge">Varies by state/uni</span>
          </div>

          <div class="box" style="margin-top:12px;">
            <h4>Evidence notes (prototype-safe)</h4>
            <ul>
              ${src.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
            </ul>
          </div>
        </div>
      </div>
    `;
  }).join("");

  Array.from(results.querySelectorAll(".card")).forEach(card=>{
    card.addEventListener("click", ()=>{
      card.classList.toggle("open");
    });
  });
}

function calcMatchPercent(p, anchor, score, salaryKey){
  // Simple, honest heuristic: (eligibility + salary fit + filter alignment + similarity)
  let s = 0.35; // base
  s += clamp((score - p.cutoff) / 40, 0, 0.25);
  s += clamp(salaryFitScore(p, salaryKey), 0, 0.25);

  // alignment with current filters
  const f = state.filters;
  let align = 0;
  if (f.study === "any" || p.studyLen === f.study) align += 0.05;
  if (f.people === "any" || p.people === f.people) align += 0.05;
  if (f.activity === "any" || p.activity === f.activity) align += 0.05;
  if (f.setting === "any" || p.setting === f.setting) align += 0.05;
  s += align;

  // if profession selected, add similarity to target
  if (state.selectedProfession){
    const sim = 1 / (1 + dist(state.selectedProfession, p));
    s += clamp(sim * 0.18, 0, 0.18);
  }

  // keep within 35‚Äì95 range so it looks sane
  const pct = Math.round(clamp(s, 0.35, 0.95) * 100);
  return pct;
}

/* -----------------------------
   Search runner
   ----------------------------- */

function runSearch(scroll=true){
  // ensure mode exists
  if (!state.mode){
    showModeModal();
    return;
  }

  const score = getScore();
  const salaryKey = $("salarySelect").value;

  // If user typed something but didn't select from list, treat as invalid and clear
  const typed = input.value.trim().toLowerCase();
  if (typed && (!state.selectedProfession || state.selectedProfession.name.toLowerCase() !== typed)){
    // try exact match in eligible list (forced list)
    const exact = getEligibleList(score).find(p=> p.name.toLowerCase() === typed);
    if (exact) state.selectedProfession = exact;
    else {
      // Not found ‚Üí clear (forced)
      state.selectedProfession = null;
      input.value = "";
    }
  }

  // Eligible professions for score
  const eligible = getEligibleList(score);

  renderEligibleCount();
  renderCategories(eligible, salaryKey);

  const shortlist = pickShortlist(eligible, salaryKey);
  renderResults(shortlist, eligible, score, salaryKey);

  $("lastUpdated").textContent = " ‚Ä¢ " + DATA_UPDATED;

  if (scroll){
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }
}

$("searchBtn").addEventListener("click", ()=> runSearch(true));

/* -----------------------------
   Save + share
   ----------------------------- */

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1600);
}

function getSelectionPayload(){
  return {
    mode: state.mode,
    score: getScore(),
    salary: $("salarySelect").value,
    filters: {...state.filters},
    category: state.selectedCategory,
    profession: state.selectedProfession ? state.selectedProfession.name : "",
    savedAt: new Date().toISOString()
  };
}

function saveToLocal(){
  const payload = getSelectionPayload();
  localStorage.setItem("cp_saved", JSON.stringify(payload));
  toast("Saved shortlist");
}

function shareLink(){
  const payload = getSelectionPayload();
  const params = new URLSearchParams();
  params.set("mode", payload.mode);
  params.set("score", String(payload.score));
  params.set("salary", payload.salary);
  params.set("study", payload.filters.study);
  params.set("people", payload.filters.people);
  params.set("activity", payload.filters.activity);
  params.set("setting", payload.filters.setting);
  if (payload.category) params.set("cat", payload.category);
  if (payload.profession) params.set("job", payload.profession);

  const url = location.origin + location.pathname + "?" + params.toString();
  navigator.clipboard?.writeText(url);
  toast("Link copied");
}

$("saveBtn").addEventListener("click", saveToLocal);
$("saveBtnTop").addEventListener("click", saveToLocal);
$("shareBtn").addEventListener("click", shareLink);

/* -----------------------------
   Reset + about
   ----------------------------- */

$("resetBtn").addEventListener("click", ()=>{
  state.selectedCategory = null;
  state.selectedProfession = null;
  input.value = "";
  $("salarySelect").value = "mid";

  // reset chips to any
  const resetGroup = (group)=>{
    Array.from(document.querySelectorAll(`.chip[data-filter="${group}"]`)).forEach(x=>x.classList.remove("on"));
    const any = document.querySelector(`.chip[data-filter="${group}"][data-value="any"]`);
    if (any) any.classList.add("on");
    state.filters[group] = "any";
  };
  resetGroup("study");
  resetGroup("people");
  resetGroup("activity");
  resetGroup("setting");

  runSearch(false);
  window.scrollTo({ top: 0, behavior: "smooth" });
});

$("aboutBtn").addEventListener("click", ()=>{
  alert(
`CareerPicker (prototype)
- Score-first: see options for your ATAR/GPA.
- Profession picker is real-list only (must exist in list).
- ‚ÄúEvidence notes‚Äù label rule-of-thumb vs formal/licensed.
Next upgrades: state/uni requirements, saved profiles, shareable reports.`
  );
});

/* -----------------------------
   Load from URL / local storage
   ----------------------------- */

function applyFromParams(){
  const params = new URLSearchParams(location.search);
  const mode = params.get("mode");
  if (mode === "ATAR" || mode === "GPA"){
    state.mode = mode;
    localStorage.setItem("cp_mode", mode);
  }

  if (state.mode){
    // set UI labels
    setMode(state.mode);
  }

  const score = params.get("score");
  if (score !== null && score !== ""){
    $("scoreInput").value = String(score);
  }

  const salary = params.get("salary");
  if (salary && SALARY_BIAS[salary]) $("salarySelect").value = salary;

  const fStudy = params.get("study");
  const fPeople = params.get("people");
  const fActivity = params.get("activity");
  const fSetting = params.get("setting");

  if (fStudy) state.filters.study = fStudy;
  if (fPeople) state.filters.people = fPeople;
  if (fActivity) state.filters.activity = fActivity;
  if (fSetting) state.filters.setting = fSetting;

  const cat = params.get("cat");
  if (cat) state.selectedCategory = cat;

  const job = params.get("job");
  if (job){
    input.value = job;
    // selectedProfession will be validated on search
  }

  // Sync chips UI to state
  function syncChips(group, val){
    const nodes = Array.from(document.querySelectorAll(`.chip[data-filter="${group}"]`));
    nodes.forEach(x=>x.classList.remove("on"));
    const match = document.querySelector(`.chip[data-filter="${group}"][data-value="${val}"]`);
    if (match) match.classList.add("on");
    else {
      const any = document.querySelector(`.chip[data-filter="${group}"][data-value="any"]`);
      if (any) any.classList.add("on");
      state.filters[group] = "any";
    }
  }
  syncChips("study", state.filters.study);
  syncChips("people", state.filters.people);
  syncChips("activity", state.filters.activity);
  syncChips("setting", state.filters.setting);
}

function applyFromSaved(){
  const raw = localStorage.getItem("cp_saved");
  if (!raw) return;
  try{
    const p = JSON.parse(raw);
    if (p.mode === "ATAR" || p.mode === "GPA"){
      state.mode = p.mode;
      setMode(p.mode);
    }
    if (typeof p.score === "number") $("scoreInput").value = String(p.score);
    if (p.salary && SALARY_BIAS[p.salary]) $("salarySelect").value = p.salary;

    if (p.filters){
      state.filters = {...state.filters, ...p.filters};
    }
    state.selectedCategory = p.category || null;
    if (p.profession){
      input.value = p.profession;
    }
  }catch(e){}
}

/* -----------------------------
   Init
   ----------------------------- */

(function init(){
  $("lastUpdated").textContent = " ‚Ä¢ " + DATA_UPDATED;

  // Load mode
  const m = defaultMode();
  if (m === "ATAR" || m === "GPA"){
    state.mode = m;
    setMode(m);
  } else {
    // force modal first time
    showModeModal();
  }

  applyFromParams();
  applyFromSaved();

  renderEligibleCount();

  // Auto-run once mode exists
  if (state.mode){
    runSearch(false);
  }
})();

</script>
</body>
</html>
